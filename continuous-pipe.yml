variables:
  - name: PUBLIC_ADDRESS
    value: https://${SERVICE_WEBCE_PUBLIC_ENDPOINT}/

tasks:
  images:
    build:
      services:
        webce:
          image: ${IMAGE_NAME}
          naming_strategy: sha1

  infrastructure:
    deploy:
      cluster: ${CLUSTER}
      environment:
        name: '"m1demo-" ~ code_reference.branch'
      services:
        database:
          specification:
            ports:
              - 3306
          deployment_strategy:
            readiness_probe:
              type: tcp
              port: 3306

        redis:
          deployment_strategy:
            readiness_probe:
              type: tcp
              port: 6379
          specification:
            ports:
              - 6379

        memcached:
          specification:
            ports:
              - 11211
          deployment_strategy:
            readiness_probe:
              type: tcp
              port: 11211

  reserve_ip:
    deploy:
      cluster: ${CLUSTER}
      environment:
        name: '"m1demo-" ~ code_reference.branch'

      services:
        webce:
          specification:
            source:
              image: continuouspipe/landing-page
              tag: latest
            accessibility:
              from_external: true

            ports:
              - 80
              - 443

    filter:
      expression: 'tasks.infrastructure.services.database.created'

  setup:
    run:
      cluster: ${CLUSTER}
      image:
        from_service: webce
      environment:
        name: '"m1demo-" ~ code_reference.branch'

      commands:
        - container setup

      environment_variables: &WEB_ENV_VARS
        - name: PUBLIC_ADDRESS
          value: https://${SERVICE_WEBCE_PUBLIC_ENDPOINT}/
    filter:
      expression: 'tasks.infrastructure.services.database.created'

  application:
    deploy:
      cluster: ${CLUSTER}
      environment:
        name: '"m1demo-" ~ code_reference.branch'
      services:
        webce:
          specification:
            accessibility:
              from_external: true
            environment_variables:
              <<: *WEB_ENV_VARS
          deployment_strategy:
            readiness_probe:
              type: tcp
              port: 80
        cron:
          specification:
            accessibility:
              from_cluster: false
            source:
              from_service: webce
            ports: []
            environment_variables:
              <<: *WEB_ENV_VARS
              1000:
                name: START_MODE
                value: cron
